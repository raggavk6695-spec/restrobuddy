<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestroBuddy</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçï</text></svg>">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316', // Orange-500
                        secondary: '#1e293b', // Slate-800
                        background: '#f8fafc', // Slate-50
                        danger: '#ef4444',
                        success: '#22c55e',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
        }
    </style>
</head>

<body class="bg-background text-slate-800 h-screen overflow-hidden selection:bg-orange-100 selection:text-orange-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext, useRef, useReducer } = React;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);

            useEffect(() => {
                if (window.lucide && iconRef.current && iconRef.current.parentNode) {
                    window.lucide.createIcons({
                        root: iconRef.current.parentNode,
                        nameAttrs: { 'data-lucide': name },
                        attrs: {
                            class: `lucide lucide-${name} ${className}`,
                            width: size,
                            height: size
                        }
                    });
                }
            }, [name, size, className]);

            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("React Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center">
                            <h2 className="text-xl font-bold text-red-600 mb-2">Something went wrong</h2>
                            <p className="text-slate-600 mb-4 bg-slate-100 p-2 rounded text-xs font-mono">{this.state.error?.toString()}</p>
                            <Button onClick={() => { localStorage.clear(); window.location.reload(); }} variant="danger">
                                Clear Data & Restart
                            </Button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- UI COMPONENTS (ShadCN style) ---
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-100 ${className}`}>{children}</div>;
        const CardHeader = ({ children, className = "" }) => <div className={`p-6 pb-2 ${className}`}>{children}</div>;
        const CardTitle = ({ children, className = "" }) => <h3 className={`text-lg font-semibold text-slate-800 ${className}`}>{children}</h3>;
        const CardContent = ({ children, className = "" }) => <div className={`p-6 pt-2 ${className}`}>{children}</div>;

        const Button = ({ children, onClick, type = "button", variant = "primary", size = "md", className = "", disabled = false }) => {
            const variants = {
                primary: "bg-primary text-white hover:bg-orange-600 shadow-sm",
                secondary: "bg-slate-100 text-slate-900 hover:bg-slate-200",
                outline: "border border-slate-200 hover:bg-slate-50 text-slate-700",
                ghost: "hover:bg-slate-100 text-slate-700",
                danger: "bg-red-500 text-white hover:bg-red-600",
                success: "bg-green-500 text-white hover:bg-green-600"
            };
            const sizes = {
                sm: "px-3 py-1.5 text-sm",
                md: "px-4 py-2",
                lg: "px-6 py-3 text-lg",
                icon: "p-2"
            };
            return (
                <button
                    type={type}
                    onClick={onClick}
                    disabled={disabled}
                    className={`rounded-lg font-medium transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${variants[variant]} ${sizes[size]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const NotificationBell = () => {
            const { notifications, markNotificationsRead, clearNotifications } = useData();
            const [isOpen, setIsOpen] = useState(false);
            const unreadCount = notifications.filter(n => !n.read).length;

            return (
                <div className="relative">
                    <button
                        onClick={() => { setIsOpen(!isOpen); if (!isOpen) markNotificationsRead(); }}
                        className="relative p-2 text-slate-500 hover:bg-slate-100 rounded-full transition-colors"
                    >
                        <Icon name="bell" size={20} />
                        {unreadCount > 0 && (
                            <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                        )}
                    </button>

                    {isOpen && (
                        <>
                            <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)}></div>
                            <div className="absolute right-0 top-full mt-2 w-80 bg-white rounded-xl shadow-xl border border-slate-100 z-50 animate-in fade-in zoom-in-95 origin-top-right overflow-hidden">
                                <div className="flex items-center justify-between p-3 border-b border-slate-50 bg-slate-50/50">
                                    <h3 className="font-semibold text-sm text-slate-800">Notifications</h3>
                                    {notifications.length > 0 && (
                                        <button onClick={clearNotifications} className="text-xs text-slate-400 hover:text-red-500">Clear all</button>
                                    )}
                                </div>
                                <div className="max-h-80 overflow-y-auto">
                                    {notifications.length === 0 ? (
                                        <div className="p-8 text-center text-slate-400 text-sm">
                                            <Icon name="bell-off" size={24} className="mx-auto mb-2 opacity-50" />
                                            <p>No notifications</p>
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-slate-50">
                                            {notifications.map(n => (
                                                <div key={n.id} className={`p-3 hover:bg-slate-50 transition-colors ${!n.read ? 'bg-blue-50/30' : ''}`}>
                                                    <div className="flex gap-3">
                                                        <div className={`mt-1 w-2 h-2 rounded-full shrink-0 ${n.type === 'error' ? 'bg-red-500' : n.type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                                                        <div>
                                                            <p className="text-sm font-medium text-slate-800">{n.title}</p>
                                                            {n.message && <p className="text-xs text-slate-500 mt-0.5">{n.message}</p>}
                                                            <p className="text-[10px] text-slate-400 mt-1.5">{new Date(n.date).toLocaleTimeString()}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const Input = ({ ...props }) => <input className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm" {...props} />;
        const Label = ({ children }) => <label className="block text-sm font-medium text-slate-700 mb-1">{children}</label>;
        const Select = ({ children, ...props }) => <select className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white text-sm" {...props}>{children}</select>;
        const Badge = ({ children, variant = "default" }) => {
            const variants = {
                default: "bg-slate-100 text-slate-800",
                success: "bg-green-100 text-green-700",
                warning: "bg-yellow-100 text-yellow-800",
                danger: "bg-red-100 text-red-700",
                primary: "bg-orange-100 text-orange-700"
            };
            return <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${variants[variant]}`}>{children}</span>;
        };

        // --- SEED DATA ---
        const SEED_DATA = {
            inventory: [],
            menu: [],
            orders: [],
            pos: [],
            transactions: [],
            notifications: []
        };

        // --- DATA CONTEXT ---
        const DataContext = createContext();

        // --- GOOGLE SHEETS SERVICE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeu8VWZ-3VJezGHALGM5B0AdpjEKGD9ax6Ud1HgiVlFCrBxdAtndn_JkWJzTRCDV2G0w/exec";

        const GoogleSheetsService = {
            async call(action, data = {}, user) {
                if (!SCRIPT_URL) return null;

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        // mode: 'no-cors', // REMOVED to allow reading response. Requires GAS deployment to allow "Anyone".
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ action, username: user, ...data })
                    });
                    const json = await response.json();
                    return json;
                } catch (e) {
                    console.error("Sheets API Error:", e);
                    return { status: 'error', message: e.message };
                }
            },

            async getData(user) {
                if (!SCRIPT_URL) return null;
                const fullUrl = `${SCRIPT_URL}?action=GET_DATA&username=${user}`;
                try {
                    const res = await fetch(fullUrl);
                    return await res.json();
                } catch (e) { console.error(e); return null; }
            }
        };


        // --- DATA PROVIDER ---
        const DataProvider = ({ children, user }) => {
            const prefix = user ? `rb_${user}_` : 'rb_';

            // Core Data State
            const [inventory, setInventory] = useState(() => JSON.parse(localStorage.getItem(prefix + 'inventory') || '[]'));
            const [menu, setMenu] = useState(() => JSON.parse(localStorage.getItem(prefix + 'menu') || '[]'));
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem(prefix + 'orders') || '[]'));
            const [pos, setPos] = useState(() => JSON.parse(localStorage.getItem(prefix + 'pos') || '[]'));
            const [notifications, setNotifications] = useState(() => JSON.parse(localStorage.getItem(prefix + 'notifications') || '[]'));
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem(prefix + 'transactions') || '[]'));
            const [purchaseOrders, setPurchaseOrders] = useState(() => JSON.parse(localStorage.getItem(prefix + 'purchase_orders') || '[]'));

            // Sync Effects - Local Storage
            useEffect(() => { localStorage.setItem(`${prefix}inventory`, JSON.stringify(inventory)); }, [inventory, prefix]);
            useEffect(() => { localStorage.setItem(`${prefix}menu`, JSON.stringify(menu)); }, [menu, prefix]);
            useEffect(() => { localStorage.setItem(`${prefix}orders`, JSON.stringify(orders)); }, [orders, prefix]);
            useEffect(() => { localStorage.setItem(`${prefix}pos`, JSON.stringify(pos)); }, [pos, prefix]);
            useEffect(() => { localStorage.setItem(prefix + 'transactions', JSON.stringify(transactions)); }, [transactions, prefix]);
            useEffect(() => { localStorage.setItem(prefix + 'purchase_orders', JSON.stringify(purchaseOrders)); }, [purchaseOrders, prefix]);

            // Cloud Sync - Function to push data
            const syncToCloud = (tableName, data) => {
                if (user && SCRIPT_URL) {
                    // Debounce or fire-and-forget
                    GoogleSheetsService.call('SYNC_DATA', { data: { [tableName]: data } }, user);
                }
            };

            // Hook up syncs to effects? 
            // Caveat: This triggers on load too. We want to avoid overwriting cloud with stale local on load if cloud is newer.
            // But for simple "Single Source of Truth is local, push to cloud" it works.
            // To be safe, we should fetch from cloud ONCE on mount, then push updates.

            // Initial Fetch
            // Initial Fetch
            useEffect(() => {
                const fetchData = async () => {
                    if (user && SCRIPT_URL) {
                        try {
                            // addNotification("Cloud Sync", "Connecting to Google Sheets...", "info"); // Validation: Too much noise on load?
                            const res = await GoogleSheetsService.getData(user);
                            if (res && res.status === 'success') {
                                const d = res.data;
                                // Validation: Ensure d is object
                                if (d && typeof d === 'object') {
                                    if (Array.isArray(d.Inventory)) setInventory(d.Inventory);
                                    if (Array.isArray(d.Menu)) setMenu(d.Menu);
                                    if (Array.isArray(d.Orders)) setOrders(d.Orders);
                                    if (Array.isArray(d.PurchaseOrders)) setPurchaseOrders(d.PurchaseOrders);
                                    if (Array.isArray(d.Transactions)) setTransactions(d.Transactions);
                                    if (Array.isArray(d.Notifications)) setNotifications(d.Notifications);
                                    console.log("Data loaded from cloud for", user);
                                }
                            }
                        } catch (e) {
                            console.error("Failed to load initial data", e);
                            addNotification("Sync Error", "Could not load cloud data.", "error");
                        }
                    }
                };
                fetchData();
            }, [user]);

            // Push Effects (Debounced slightly by nature of React updates? No, direct call)
            // We use a ref to skip initial mount sync to avoid "pushing what we just fetched"? 
            // Actually, if we just fetched, state updates, then this effect fires, pushing it back. Redundant but harmless if idempotent.
            const isMounted = useRef(false);
            useEffect(() => { if (isMounted.current) syncToCloud('Inventory', inventory); }, [inventory]);
            useEffect(() => { if (isMounted.current) syncToCloud('Menu', menu); }, [menu]);
            useEffect(() => { if (isMounted.current) syncToCloud('Orders', orders); }, [orders]);
            useEffect(() => { if (isMounted.current) syncToCloud('PurchaseOrders', purchaseOrders); }, [purchaseOrders]);
            useEffect(() => { if (isMounted.current) syncToCloud('Transactions', transactions); }, [transactions]);
            // Not syncing notifications to cloud to reduce noise, or user wants it? "All backend data storage". Okay.
            // useEffect(() => { if (isMounted.current) syncToCloud('Notifications', notifications); }, [notifications]);

            useEffect(() => { isMounted.current = true; }, []);

            // Notification helpers
            const addNotification = (title, message = '', type = 'info') => {
                const newNote = {
                    id: Date.now(),
                    title,
                    message,
                    type,
                    date: new Date().toISOString(),
                    read: false
                };
                setNotifications(prev => [newNote, ...prev].slice(0, 50));
            };

            const markNotificationsRead = () => {
                setNotifications(prev => prev.map(n => ({ ...n, read: true })));
            };

            const clearNotifications = () => {
                if (confirm("Clear all notifications?")) setNotifications([]);
            };
            useEffect(() => { localStorage.setItem('rb_notifications', JSON.stringify(notifications)); }, [notifications]);

            const addOrder = (orderData) => {
                const items = Array.isArray(orderData) ? orderData : orderData.items;
                const method = Array.isArray(orderData) ? 'Cash' : (orderData.method || 'Cash');

                const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const newOrder = {
                    id: `ORD-${Math.floor(Math.random() * 10000)}`,
                    items,
                    status: 'pending',
                    total,
                    method,
                    date: new Date().toISOString()
                };

                // Inventory deduction moved to 'ready' status update

                // setInventory(newInventory); // Moved to updateOrderStatus
                setOrders([newOrder, ...orders]);
                setTransactions([...transactions, { id: Date.now(), type: 'income', amount: total, date: new Date().toISOString(), desc: `Order #${newOrder.id}` }]);
                addNotification("Order Placed", `New order #${newOrder.id} - $${total.toFixed(2)}`, "info");
                return newOrder.id;
            };

            const updateOrderStatus = (orderId, status) => {
                const order = orders.find(o => o.id === orderId);
                if (!order) return;

                if (status === 'ready' && !order.deducted) {
                    // Deduct Inventory
                    const newInventory = [...inventory];
                    order.items.forEach(orderItem => {
                        const menuItem = menu.find(m => m.id === orderItem.id);
                        if (menuItem && menuItem.ingredients) {
                            menuItem.ingredients.forEach(ing => {
                                const stockItemIdx = newInventory.findIndex(i => i.id === ing.id);
                                if (stockItemIdx > -1) {
                                    newInventory[stockItemIdx].stock -= (ing.qty * orderItem.qty);
                                }
                            });
                        }
                    });
                    setInventory(newInventory);
                    setOrders(orders.map(o => o.id === orderId ? { ...o, status, deducted: true } : o));
                    addNotification("Order Ready", `Order #${orderId} is ready for pickup.`, "success");
                } else if (status === 'cancelled') {
                    // Restore Inventory if deducted
                    if (order.deducted) {
                        const newInventory = [...inventory];
                        order.items.forEach(orderItem => {
                            const menuItem = menu.find(m => m.id === orderItem.id);
                            if (menuItem && menuItem.ingredients) {
                                menuItem.ingredients.forEach(ing => {
                                    const stockItemIdx = newInventory.findIndex(i => i.id === ing.id);
                                    if (stockItemIdx > -1) {
                                        newInventory[stockItemIdx].stock += (ing.qty * orderItem.qty);
                                    }
                                });
                            }
                        });
                        setInventory(newInventory);
                        setOrders(orders.map(o => o.id === orderId ? { ...o, status, deducted: false } : o));
                    } else {
                        // Just cancel without restore
                        setOrders(orders.map(o => o.id === orderId ? { ...o, status } : o));
                    }
                } else {
                    setOrders(orders.map(o => o.id === orderId ? { ...o, status } : o));
                }
            };

            const addIngredient = (ing) => {
                if (ing.id) {
                    setInventory(inventory.map(i => i.id === ing.id ? ing : i));
                } else {
                    setInventory([...inventory, { ...ing, id: Date.now() }]);
                }
            };

            const deleteIngredient = (id) => {
                setInventory(inventory.filter(i => i.id !== id));
            };

            const addExpense = (amount, desc) => {
                setTransactions([...transactions, { id: Date.now(), type: 'expense', amount: parseFloat(amount), date: new Date().toISOString(), desc }]);
            };

            const restockIngredient = (id, qty, cost) => {
                const ingredient = inventory.find(i => i.id === id);
                if (ingredient) {
                    const newInventory = inventory.map(i =>
                        i.id === id ? { ...i, stock: i.stock + parseFloat(qty) } : i
                    );
                    setInventory(newInventory);
                    // Use cost passed or calculate based on unit cost?
                    // For manual restock form, we pass total cost directly
                    addExpense(cost, `Restock: ${ingredient.name} (+${qty} ${ingredient.unit})`);
                }
            };


            const addPO = (po) => {
                setPurchaseOrders([...purchaseOrders, { ...po, id: `PO-${Date.now()}`, status: 'pending' }]);
            };

            const receivePO = (poId) => {
                const po = purchaseOrders.find(p => p.id === poId);
                if (po && po.status !== 'received') {
                    const newInventory = [...inventory];
                    let totalCost = 0;
                    po.items.forEach(item => {
                        const stockItemIdx = newInventory.findIndex(i => i.id === item.id);
                        if (stockItemIdx > -1) {
                            newInventory[stockItemIdx].stock += parseFloat(item.qty);
                            // Update cost if needed? For now we just use the PO unit cost for expense
                            totalCost += (item.qty * item.unitCost);
                        }
                    });
                    setInventory(newInventory);
                    setPurchaseOrders(purchaseOrders.map(p => p.id === poId ? { ...p, status: 'received' } : p));
                    addExpense(totalCost, `PO Received: #${poId} (${po.vendor})`);
                    addNotification("PO Received", `Received order from ${po.vendor}. Inventory updated.`, "success");
                }
            };

            const updatePODate = (poId, newDate) => {
                setPurchaseOrders(purchaseOrders.map(p => p.id === poId ? { ...p, deliveryDate: newDate } : p));
                addNotification("PO Updated", `Delivery date updated for PO: ${poId}`, "info");
            };

            const deletePO = (poId) => {
                const po = purchaseOrders.find(p => p.id === poId);
                setPurchaseOrders(purchaseOrders.filter(p => p.id !== poId));
                if (po) addNotification("PO Deleted", `Order to ${po.vendor} was deleted.`, "info");
            };




            const addMenu = (item) => {
                if (item.id) {
                    setMenu(menu.map(m => m.id === item.id ? item : m));
                } else {
                    setMenu([...menu, { ...item, id: Date.now() }]);
                }
            };

            const deleteMenu = (id) => {
                setMenu(menu.filter(m => m.id !== id));
            };

            const resetData = () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(prefix)) localStorage.removeItem(key);
                });
                window.location.reload();
            };

            return (
                <DataContext.Provider value={{
                    inventory, menu, orders, transactions, purchaseOrders, notifications,
                    addOrder, updateOrderStatus, addIngredient, deleteIngredient, addExpense, resetData,
                    addMenu, deleteMenu, restockIngredient,
                    addPO, receivePO, updatePODate, deletePO,
                    addNotification, markNotificationsRead, clearNotifications
                }}>
                    {children}
                </DataContext.Provider>
            );
        };

        const useData = () => useContext(DataContext);

        // --- DASHBOARD VIEW (Modernized) ---
        const Dashboard = () => {
            const { orders, transactions, inventory, purchaseOrders } = useData();

            const today = new Date().toDateString();
            const todayOrders = orders.filter(o => new Date(o.date).toDateString() === today);
            const todayRevenue = transactions
                .filter(t => t.type === 'income' && new Date(t.date).toDateString() === today)
                .reduce((sum, t) => sum + t.amount, 0);

            const criticalStock = inventory.filter(i => i.stock <= 0).length;
            const lowStock = inventory.filter(i => i.stock > 0 && i.stock <= i.minStock).length;
            const pendingPOs = purchaseOrders.filter(po => po.status === 'pending').length;

            const StatCard = ({ title, value, icon, color, subValue, trend }) => (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-all group">
                    <div>
                        <div className={`p-2 w-fit rounded-lg ${color} bg-opacity-10 text-opacity-100 mb-3 group-hover:scale-110 transition-transform`}>
                            <Icon name={icon} size={24} className={color.replace('bg-', 'text-')} />
                        </div>
                        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                        <h3 className="text-3xl font-bold text-slate-800 tracking-tight">{value}</h3>
                        {(subValue || trend) && (
                            <div className="flex items-center gap-2 mt-2">
                                {trend && <span className="text-xs font-medium text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded flex items-center gap-1"><Icon name="trending-up" size={12} /> {trend}</span>}
                                {subValue && <p className="text-xs text-slate-400">{subValue}</p>}
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="space-y-6 fade-in pb-12">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800">Dashboard</h2>
                        <p className="text-slate-500 text-sm">Welcome back, here's what's happening today.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard
                            title="Daily Revenue"
                            value={`$${todayRevenue.toFixed(2)}`}
                            icon="dollar-sign"
                            color="bg-emerald-500"
                            trend="+12% from yesterday"
                        />
                        <StatCard
                            title="Today's Orders"
                            value={todayOrders.length}
                            icon="shopping-bag"
                            color="bg-blue-500"
                            subValue={`${todayOrders.filter(o => o.status === 'completed').length} Completed`}
                        />
                        <StatCard
                            title="Stock Alerts"
                            value={criticalStock + lowStock}
                            subValue={`${criticalStock} Critical, ${lowStock} Low`}
                            icon="alert-triangle"
                            color={criticalStock > 0 ? "bg-red-500" : "bg-orange-400"}
                        />
                        <StatCard
                            title="Pending POs"
                            value={pendingPOs}
                            subValue="Unreceived Orders"
                            icon="truck"
                            color="bg-purple-500"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card className="h-full">
                            <CardHeader><CardTitle>Recent Activity</CardTitle></CardHeader>
                            <CardContent>
                                <div className="space-y-4">
                                    {orders.slice(0, 5).map(order => (
                                        <div key={order.id} className="flex items-center justify-between border-b border-slate-50 pb-2 last:border-0 last:pb-0">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold">
                                                    #{order.id.slice(0, 4)}
                                                </div>
                                                <div>
                                                    <p className="text-sm font-medium text-slate-800">{order.method} Order</p>
                                                    <p className="text-xs text-slate-400">{new Date(order.date).toLocaleTimeString()}</p>
                                                </div>
                                            </div>
                                            <span className="font-bold text-slate-700">${order.total.toFixed(2)}</span>
                                        </div>
                                    ))}
                                    {orders.length === 0 && <p className="text-sm text-slate-400 text-center py-4">No recent activity.</p>}
                                </div>
                            </CardContent>
                        </Card>

                        <Card className="h-full">
                            <CardHeader><CardTitle>Low Stock Items</CardTitle></CardHeader>
                            <CardContent>
                                <div className="space-y-3">
                                    {inventory.filter(i => i.stock <= i.minStock).slice(0, 5).map(item => (
                                        <div key={item.id} className="flex items-center justify-between bg-orange-50/50 p-2 rounded-lg border border-orange-100">
                                            <div className="flex items-center gap-2">
                                                <Icon name="alert-circle" size={16} className="text-orange-500" />
                                                <span className="text-sm font-medium text-slate-700">{item.name}</span>
                                            </div>
                                            <div className="text-xs font-bold text-orange-700 bg-orange-100 px-2 py-1 rounded-full">
                                                {item.stock} {item.unit} Left
                                            </div>
                                        </div>
                                    ))}
                                    {inventory.filter(i => i.stock <= i.minStock).length === 0 && (
                                        <div className="text-center py-8 text-slate-400">
                                            <Icon name="check-circle" size={32} className="mx-auto mb-2 text-emerald-400" />
                                            <p className="text-sm">All items well stocked!</p>
                                        </div>
                                    )}
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- POS VIEW ---
        const POS = () => {
            const { menu, addOrder, addNotification } = useData();
            const [cart, setCart] = useState([]);
            const [category, setCategory] = useState('All');
            const [isMobileCartOpen, setIsMobileCartOpen] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');

            const categories = ['All', ...new Set(menu.map(m => m.category || 'Other'))];
            const filteredMenu = menu.filter(item =>
                (category === 'All' || item.category === category) &&
                item.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const addToCart = (item) => {
                const existing = cart.find(c => c.id === item.id);
                if (existing) {
                    setCart(cart.map(c => c.id === item.id ? { ...c, qty: c.qty + 1 } : c));
                } else {
                    setCart([...cart, { ...item, qty: 1 }]);
                }
            };

            const updateQty = (id, delta) => {
                setCart(cart.map(c => {
                    if (c.id === id) return { ...c, qty: Math.max(0, c.qty + delta) };
                    return c;
                }).filter(c => c.qty > 0));
            };

            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            const handleCheckout = () => {
                if (cart.length === 0) return;
                addOrder({ items: cart, total, method: 'Cash' });
                setCart([]);
                setIsMobileCartOpen(false);
                addNotification("Order Placed", `Order for $${total.toFixed(2)} sent to kitchen.`, "success");
            };

            // Cart Component (Reusable for Desktop & Mobile Sheet)
            const CartSection = () => (
                <div className="flex flex-col h-full bg-white shadow-sm border border-slate-100 rounded-2xl overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                        <h2 className="font-bold text-lg text-slate-800">Current Order</h2>
                        <span className="bg-orange-100 text-orange-700 text-xs font-bold px-2 py-1 rounded-full">{cart.length} items</span>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {cart.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60">
                                <Icon name="shopping-cart" size={48} className="mb-2" />
                                <p>Cart is empty</p>
                            </div>
                        ) : (
                            cart.map(item => (
                                <div key={item.id} className="flex items-center justify-between bg-white border border-slate-100 p-2 rounded-xl shadow-sm">
                                    <div className="flex-1">
                                        <p className="font-semibold text-slate-800 text-sm">{item.name}</p>
                                        <p className="text-xs text-orange-600 font-medium">${item.price}</p>
                                    </div>
                                    <div className="flex items-center gap-3 bg-slate-50 rounded-lg p-1">
                                        <button onClick={() => updateQty(item.id, -1)} className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-red-500 active:scale-95 transition-all"><Icon name="minus" size={14} /></button>
                                        <span className="text-sm font-bold w-4 text-center">{item.qty}</span>
                                        <button onClick={() => updateQty(item.id, 1)} className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-green-500 active:scale-95 transition-all"><Icon name="plus" size={14} /></button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    <div className="p-4 bg-slate-50 border-t border-slate-100">
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-slate-500 font-medium">Total</span>
                            <span className="text-2xl font-bold text-slate-900">${total.toFixed(2)}</span>
                        </div>
                        <Button onClick={handleCheckout} className="w-full py-3 h-auto text-lg shadow-orange-200 shadow-xl" disabled={cart.length === 0}>
                            Checkout <Icon name="arrow-right" size={20} className="ml-2 inline" />
                        </Button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col lg:flex-row h-[calc(100vh-140px)] gap-6 fade-in relative">
                    {/* Left: Menu Grid */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden">
                        {/* Filters */}
                        <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
                            {categories.map(cat => (
                                <button
                                    key={cat}
                                    onClick={() => setCategory(cat)}
                                    className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all shadow-sm ${category === cat
                                        ? 'bg-orange-600 text-white shadow-orange-200'
                                        : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'
                                        }`}
                                >
                                    {cat}
                                </button>
                            ))}
                        </div>

                        {/* Search */}
                        <div className="mb-4 relative">
                            <Icon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                            <input
                                type="text"
                                placeholder="Search menu..."
                                className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 bg-white shadow-sm transition-all"
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                            />
                        </div>

                        {/* Grid */}
                        <div className="flex-1 overflow-y-auto pr-1">
                            <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20 lg:pb-0">
                                {filteredMenu.map(item => (
                                    <div
                                        key={item.id}
                                        onClick={() => addToCart(item)}
                                        className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 cursor-pointer hover:shadow-md hover:border-orange-200 transition-all group active:scale-95"
                                    >
                                        <div className="w-10 h-10 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                            <span className="font-bold text-lg">{item.emoji || 'üçΩÔ∏è'}</span>
                                        </div>
                                        <h3 className="font-bold text-slate-800 leading-tight mb-1">{item.name}</h3>
                                        <p className="text-orange-600 font-semibold">${item.price}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Desktop Cart (Visible lg+) */}
                    <div className="hidden lg:flex w-96 flex-col h-full">
                        <CartSection />
                    </div>

                    {/* Mobile Cart Floating Button */}
                    <div className="lg:hidden fixed bottom-20 left-4 right-4 z-40">
                        {cart.length > 0 && (
                            <button
                                onClick={() => setIsMobileCartOpen(true)}
                                className="w-full bg-slate-900 text-white p-4 rounded-xl shadow-2xl flex items-center justify-between animate-bounce-short"
                            >
                                <div className="flex items-center gap-2">
                                    <div className="bg-orange-500 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">{cart.length}</div>
                                    <span className="font-medium">View Cart</span>
                                </div>
                                <span className="font-bold text-lg">${total.toFixed(2)}</span>
                            </button>
                        )}
                    </div>

                    {/* Mobile Cart Overlay */}
                    {isMobileCartOpen && (
                        <div className="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm lg:hidden flex justify-end">
                            <div className="w-full h-full bg-slate-50 flex flex-col animate-slide-up">
                                <div className="p-4 bg-white border-b border-slate-200 flex items-center justify-between">
                                    <h2 className="font-bold text-lg">Your Order</h2>
                                    <button onClick={() => setIsMobileCartOpen(false)} className="p-2 bg-slate-100 rounded-full text-slate-600"><Icon name="x" size={20} /></button>
                                </div>
                                <div className="flex-1 overflow-hidden p-4">
                                    <CartSection />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // --- INVENTORY VIEW (Modernized) ---
        const Inventory = () => {
            const { inventory, addIngredient, deleteIngredient } = useData();
            const [isEditing, setIsEditing] = useState(null);
            const [formData, setFormData] = useState({ name: '', stock: '', unit: 'kg', minStock: '', cost: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                addIngredient({ ...formData, stock: Number(formData.stock), minStock: Number(formData.minStock), cost: Number(formData.cost) });
                setIsEditing(null);
                setFormData({ name: '', stock: '', unit: 'kg', minStock: '', cost: '' });
            };

            const startEdit = (item) => {
                setFormData(item || { name: '', stock: '', unit: 'kg', minStock: '', cost: '' });
                setIsEditing(true);
            };

            const RowAction = ({ onClick, icon, color }) => (
                <button onClick={(e) => { e.stopPropagation(); onClick(); }} className={`p-1.5 rounded-lg hover:bg-slate-100 ${color} transition-colors`}>
                    <Icon name={icon} size={16} />
                </button>
            );

            return (
                <div className="space-y-6 fade-in pb-20">
                    <Card>
                        <CardHeader className="flex flex-row items-center justify-between">
                            <CardTitle>Inventory</CardTitle>
                            <Button size="sm" onClick={() => startEdit(null)}><Icon name="plus" size={16} className="mr-2" /> Add Item</Button>
                        </CardHeader>
                        <CardContent>
                            {/* Mobile Card View */}
                            <div className="md:hidden space-y-3">
                                {inventory.map(item => (
                                    <div key={item.id} className="bg-white border border-slate-100 rounded-xl p-3 shadow-sm flex items-center justify-between" onClick={() => startEdit(item)}>
                                        <div>
                                            <p className="font-semibold text-slate-800">{item.name}</p>
                                            <p className="text-xs text-slate-500">Min: {item.minStock} {item.unit} | ${item.cost || 0}/unit</p>
                                        </div>
                                        <div className="text-right">
                                            <p className={`font-bold ${item.stock <= item.minStock ? 'text-red-500' : 'text-emerald-600'}`}>
                                                {item.stock} <span className="text-xs font-normal text-slate-400">{item.unit}</span>
                                            </p>
                                            <div className="flex justify-end mt-2 gap-2">
                                                <RowAction icon="trash-2" color="text-red-400 hover:text-red-600" onClick={() => { if (confirm('Delete ' + item.name + '?')) deleteIngredient(item.id) }} />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Desktop Table View */}
                            <div className="hidden md:block overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-y border-slate-100">
                                        <tr>
                                            <th className="px-4 py-3 font-medium">Item</th>
                                            <th className="px-4 py-3 font-medium">Stock</th>
                                            <th className="px-4 py-3 font-medium">Unit</th>
                                            <th className="px-4 py-3 font-medium">Cost/Unit</th>
                                            <th className="px-4 py-3 font-medium">Status</th>
                                            <th className="px-4 py-3 font-medium text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {inventory.map(item => (
                                            <tr key={item.id} className="group hover:bg-slate-50/50 transition-colors cursor-pointer" onClick={() => startEdit(item)}>
                                                <td className="px-4 py-3 font-medium text-slate-700">{item.name}</td>
                                                <td className={`px-4 py-3 font-bold ${item.stock <= item.minStock ? 'text-red-500' : 'text-emerald-600'}`}>
                                                    {item.stock}
                                                </td>
                                                <td className="px-4 py-3 text-slate-500">{item.unit}</td>
                                                <td className="px-4 py-3 text-slate-500">${item.cost || 0}</td>
                                                <td className="px-4 py-3">
                                                    {item.stock <= 0 ? <span className="text-red-500 font-bold text-xs bg-red-50 px-2 py-0.5 rounded">Critical</span> :
                                                        item.stock <= item.minStock ? <span className="text-orange-500 font-bold text-xs bg-orange-50 px-2 py-0.5 rounded">Low</span> :
                                                            <span className="text-emerald-500 font-bold text-xs bg-emerald-50 px-2 py-0.5 rounded">OK</span>}
                                                </td>
                                                <td className="px-4 py-3 text-right flex justify-end gap-1">
                                                    <RowAction icon="trash-2" color="text-slate-400 hover:text-red-600" onClick={() => { if (confirm('Delete ' + item.name + '?')) deleteIngredient(item.id) }} />
                                                </td>
                                            </tr>
                                        ))}
                                        {inventory.length === 0 && <tr><td colSpan="6" className="text-center py-8 text-slate-400">No inventory items</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>

                    {/* Edit/Add Modal */}
                    {isEditing && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in">
                            <Card className="w-full max-w-md shadow-2xl">
                                <CardHeader className="flex flex-row items-center justify-between border-b border-slate-100 pb-4">
                                    <CardTitle>{formData.id ? 'Edit Ingredient' : 'New Ingredient'}</CardTitle>
                                    <button onClick={() => setIsEditing(null)} className="text-slate-400 hover:text-slate-600"><Icon name="x" size={20} /></button>
                                </CardHeader>
                                <CardContent className="pt-4">
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        <div className="space-y-1">
                                            <label className="text-sm font-medium text-slate-700">Name</label>
                                            <Input required value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} placeholder="e.g. Flour" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Stock</label>
                                                <Input required type="number" step="0.01" value={formData.stock} onChange={e => setFormData({ ...formData, stock: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Unit</label>
                                                <select className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20" value={formData.unit} onChange={e => setFormData({ ...formData, unit: e.target.value })}>
                                                    <option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="pcs">pcs</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Min Stock</label>
                                                <Input required type="number" step="0.01" value={formData.minStock} onChange={e => setFormData({ ...formData, minStock: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Cost per Unit</label>
                                                <Input type="number" step="0.01" value={formData.cost || ''} onChange={e => setFormData({ ...formData, cost: e.target.value })} placeholder="0.00" />
                                            </div>
                                        </div>
                                        <div className="pt-2 flex justify-end gap-2">
                                            <Button type="button" variant="secondary" onClick={() => setIsEditing(null)} className="bg-slate-100 text-slate-600 hover:bg-slate-200">Cancel</Button>
                                            <Button type="submit">{formData.id ? 'Save Changes' : 'Add Item'}</Button>
                                        </div>
                                    </form>
                                </CardContent>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        // --- MENU VIEW (Modernized) ---
        const Menu = () => {
            const { menu, inventory, addMenu, deleteMenu } = useData();
            const [isEditing, setIsEditing] = useState(null);
            const [formData, setFormData] = useState({ name: '', price: '', category: '', ingredients: [], emoji: '' });
            const [newIng, setNewIng] = useState({ id: '', qty: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                addMenu({ ...formData, price: parseFloat(formData.price) });
                setIsEditing(null);
                setFormData({ name: '', price: '', category: '', ingredients: [], emoji: '' });
            };

            const startEdit = (item) => {
                setFormData(item || { name: '', price: '', category: '', ingredients: [], emoji: '' });
                setIsEditing(true);
            };

            const addIng = () => {
                if (newIng.id && newIng.qty) {
                    setFormData({ ...formData, ingredients: [...formData.ingredients, { id: parseInt(newIng.id), qty: parseFloat(newIng.qty) }] });
                    setNewIng({ id: '', qty: '' });
                }
            };

            const removeIng = (idx) => {
                setFormData({ ...formData, ingredients: formData.ingredients.filter((_, i) => i !== idx) });
            };

            return (
                <div className="space-y-6 fade-in pb-20">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Menu & Recipes</h2>
                        <Button onClick={() => startEdit(null)}><Icon name="plus" size={18} /> Add Item</Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {menu.map(item => (
                            <Card key={item.id} className="hover:shadow-lg transition-shadow group relative">
                                <CardHeader className="pb-2">
                                    <div className="flex justify-between items-start">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center text-xl">{item.emoji || 'üçΩÔ∏è'}</div>
                                            <div>
                                                <CardTitle className="text-lg">{item.name}</CardTitle>
                                                <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full mt-1 inline-block">{item.category}</span>
                                            </div>
                                        </div>
                                        <span className="font-bold text-lg text-primary">${item.price}</span>
                                    </div>
                                </CardHeader>
                                <CardContent>
                                    <div className="mb-4 bg-slate-50/50 p-3 rounded-lg border border-slate-100/50">
                                        <p className="text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Recipe</p>
                                        <ul className="text-sm text-slate-600 space-y-1">
                                            {item.ingredients?.map((ing, i) => {
                                                const invItem = inventory.find(inv => inv.id === ing.id);
                                                return <li key={i} className="flex justify-between text-xs"><span>{invItem?.name || 'Unknown'}</span> <span className="font-mono text-slate-400">{ing.qty} {invItem?.unit}</span></li>;
                                            })}
                                            {(!item.ingredients || item.ingredients.length === 0) && <li className="text-slate-400 italic text-xs">No ingredients linked</li>}
                                        </ul>
                                    </div>
                                    <div className="flex justify-end gap-2 border-t border-slate-50 pt-3">
                                        <Button variant="ghost" size="sm" onClick={() => startEdit(item)} className="text-slate-400 hover:text-primary"><Icon name="edit-2" size={16} /></Button>
                                        <Button variant="ghost" size="sm" onClick={() => { if (confirm("Delete this item?")) deleteMenu(item.id); }} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={16} /></Button>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>

                    {isEditing && (
                        <div className="fixed inset-0 bg-slate-900/40 flex items-center justify-center p-4 z-50 backdrop-blur-sm animate-in fade-in">
                            <Card className="w-full max-w-lg shadow-2xl">
                                <CardHeader className="flex flex-row items-center justify-between border-b border-slate-100 pb-4"><CardTitle>{formData.id ? 'Edit Item' : 'New Item'}</CardTitle>
                                    <button onClick={() => setIsEditing(null)} className="text-slate-400 hover:text-slate-600"><Icon name="x" size={20} /></button>
                                </CardHeader>
                                <CardContent className="pt-4">
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Name</label>
                                                <Input value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} required />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Category</label>
                                                <Input value={formData.category} onChange={e => setFormData({ ...formData, category: e.target.value })} list="categories" required />
                                                <datalist id="categories"><option value="Starters" /><option value="Main Course" /><option value="Drinks" /><option value="Desserts" /></datalist>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Price ($)</label>
                                                <Input type="number" step="0.01" value={formData.price} onChange={e => setFormData({ ...formData, price: e.target.value })} required />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Emoji icon</label>
                                                <Input value={formData.emoji} onChange={e => setFormData({ ...formData, emoji: e.target.value })} placeholder="üçî" />
                                            </div>
                                        </div>

                                        <div className="border-t border-slate-100 pt-4">
                                            <label className="text-sm font-medium text-slate-700 mb-2 block">Recipe Ingredients</label>
                                            <div className="flex gap-2 mb-2">
                                                <select className="flex-1 h-10 rounded-md border border-slate-200 bg-white px-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20" value={newIng.id} onChange={e => setNewIng({ ...newIng, id: e.target.value })}>
                                                    <option value="">Select Ingredient</option>
                                                    {inventory.map(i => <option key={i.id} value={i.id}>{i.name}</option>)}
                                                </select>
                                                <Input type="number" step="0.01" placeholder="Qty" value={newIng.qty} onChange={e => setNewIng({ ...newIng, qty: e.target.value })} className="w-24" />
                                                <Button type="button" onClick={addIng} type="button"><Icon name="plus" size={16} /></Button>
                                            </div>
                                            <div className="bg-slate-50 p-2 rounded-lg max-h-32 overflow-y-auto space-y-1 border border-slate-100">
                                                {formData.ingredients.length === 0 && <p className="text-xs text-slate-400 text-center py-2">No ingredients added.</p>}
                                                {formData.ingredients.map((ing, idx) => (
                                                    <div key={idx} className="flex justify-between items-center text-sm bg-white p-2 rounded shadow-sm">
                                                        <span>{inventory.find(i => i.id === ing.id)?.name || 'Unknown'}</span>
                                                        <div className="flex gap-3 items-center">
                                                            <span className="font-mono text-slate-500 bg-slate-100 px-1.5 rounded text-xs">{ing.qty}</span>
                                                            <button type="button" onClick={() => removeIng(idx)} className="text-slate-400 hover:text-red-500"><Icon name="x" size={14} /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="flex justify-end gap-2 mt-4 pt-2 border-t border-slate-100">
                                            <Button type="button" variant="secondary" onClick={() => setIsEditing(null)} className="bg-slate-100 text-slate-600 hover:bg-slate-200">Cancel</Button>
                                            <Button type="submit">Save Item</Button>
                                        </div>
                                    </form>
                                </CardContent>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        // --- KITCHEN VIEW (Kanban Style) ---
        const Kitchen = () => {
            const { orders, updateOrderStatus, addNotification } = useData();
            const activeOrders = orders.filter(o => o.status !== 'completed' && o.status !== 'cancelled');

            const getOrdersByStatus = (status) => activeOrders.filter(o => o.status === status).sort((a, b) => new Date(a.date) - new Date(b.date));

            const columns = [
                { id: 'pending', title: 'Pending', color: 'orange', actionLabel: 'Start Cooking', next: 'preparing' },
                { id: 'preparing', title: 'Preparing', color: 'blue', actionLabel: 'Mark Ready', next: 'ready' },
                { id: 'ready', title: 'Ready', color: 'emerald', actionLabel: 'Complete', next: 'completed' }
            ];

            const handleStatusUpdate = (orderId, newStatus) => {
                updateOrderStatus(orderId, newStatus);
                if (newStatus === 'ready') addNotification("Order Ready", `Order #${orderId.slice(0, 4)} is ready for pickup!`, "success");
            };

            return (
                <div className="h-[calc(100vh-140px)] flex flex-col fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Kitchen Display</h2>
                        <div className="flex gap-2">
                            <span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">{activeOrders.length} Active Orders</span>
                        </div>
                    </div>

                    <div className="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                        <div className="h-full grid grid-cols-1 md:grid-cols-3 gap-6 min-w-[300px] md:min-w-0">
                            {columns.map(col => {
                                const colOrders = getOrdersByStatus(col.id);
                                return (
                                    <div key={col.id} className="flex flex-col h-full bg-slate-50 rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                        {/* Column Header */}
                                        <div className={`p-4 border-b border-slate-200 flex justify-between items-center bg-white`}>
                                            <div className="flex items-center gap-2">
                                                <div className={`w-3 h-3 rounded-full bg-${col.color}-500`}></div>
                                                <h3 className="font-bold text-slate-700">{col.title}</h3>
                                            </div>
                                            <span className="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-full">{colOrders.length}</span>
                                        </div>

                                        {/* Orders List */}
                                        <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                            {colOrders.length === 0 && (
                                                <div className="text-center py-10 opacity-40">
                                                    <Icon name={col.id === 'pending' ? 'clipboard' : col.id === 'preparing' ? 'loader' : 'check-circle'} size={32} className="mx-auto mb-2" />
                                                    <p className="text-xs font-medium">No orders</p>
                                                </div>
                                            )}
                                            {colOrders.map(order => (
                                                <Card key={order.id} className="shadow-sm hover:shadow-md transition-all border-l-4" style={{ borderLeftColor: `var(--color-${col.color}-500)` }}>
                                                    <CardContent className="p-4">
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div>
                                                                <h4 className="font-bold text-slate-800">#{order.id.slice(0, 4)}</h4>
                                                                <p className="text-xs text-slate-500">{new Date(order.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                                            </div>
                                                            {/* Timer or Badge could go here */}
                                                        </div>

                                                        <div className="space-y-1 mb-4">
                                                            {order.items.map((item, i) => (
                                                                <div key={i} className="flex justify-between text-sm">
                                                                    <span className="text-slate-700">{item.name}</span>
                                                                    <span className="font-bold text-slate-900">x{item.qty}</span>
                                                                </div>
                                                            ))}
                                                        </div>

                                                        <div className="flex gap-2">
                                                            <Button
                                                                onClick={() => handleStatusUpdate(order.id, col.next)}
                                                                className={`flex-1 justify-center text-xs py-2 h-8 ${col.id === 'ready' ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-slate-800 hover:bg-slate-700'}`}
                                                            >
                                                                {col.actionLabel}
                                                            </Button>
                                                            {col.id === 'pending' && (
                                                                <Button
                                                                    variant="danger"
                                                                    onClick={() => { if (confirm('Cancel order? This will remove it from the list.')) handleStatusUpdate(order.id, 'cancelled'); }}
                                                                    className="px-2 h-8"
                                                                    title="Cancel Order"
                                                                >
                                                                    <Icon name="x" size={16} />
                                                                </Button>
                                                            )}
                                                        </div>
                                                    </CardContent>
                                                </Card>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ORDERS HISTORY VIEW (Modernized) ---
        const OrdersHistory = () => {
            const { orders } = useData();
            const completedOrders = orders.filter(o => o.status === 'completed' || o.status === 'cancelled').sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="space-y-6 fade-in pb-20">
                    <h2 className="text-2xl font-bold text-slate-800">Orders History</h2>

                    {/* Desktop Table View */}
                    <div className="hidden md:block">
                        <Card className="overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 text-slate-500 border-b border-slate-100">
                                        <tr>
                                            <th className="p-4 font-medium">Order ID</th>
                                            <th className="p-4 font-medium">Date & Time</th>
                                            <th className="p-4 font-medium">Items</th>
                                            <th className="p-4 font-medium text-right">Total</th>
                                            <th className="p-4 font-medium text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {completedOrders.length === 0 && (
                                            <tr>
                                                <td colSpan="5" className="p-8 text-center text-slate-400">No completed orders yet.</td>
                                            </tr>
                                        )}
                                        {completedOrders.map(order => (
                                            <tr key={order.id} className="hover:bg-slate-50/50 transition-colors">
                                                <td className="p-4 font-mono font-medium text-slate-700">#{order.id.slice(0, 8)}</td>
                                                <td className="p-4 text-slate-600">
                                                    {new Date(order.date).toLocaleDateString()} <span className="text-xs text-slate-400 block">{new Date(order.date).toLocaleTimeString()}</span>
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex flex-col gap-1">
                                                        {order.items.map((item, i) => (
                                                            <span key={i} className="text-slate-600 text-xs">
                                                                <span className="font-bold text-slate-800">{item.qty}x</span> {item.name}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </td>
                                                <td className="p-4 font-bold text-slate-800 text-right">${order.total.toFixed(2)}</td>
                                                <td className="p-4 text-center">
                                                    <Badge variant={order.status === 'completed' ? 'success' : 'danger'}>
                                                        {order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                                                    </Badge>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>

                    {/* Mobile Card View */}
                    <div className="md:hidden space-y-4">
                        {completedOrders.length === 0 && (
                            <div className="p-8 text-center text-slate-400 bg-slate-50 rounded-xl border border-slate-100 border-dashed">
                                No completed orders yet.
                            </div>
                        )}
                        {completedOrders.map(order => (
                            <Card key={order.id} className="active:scale-[0.99] transition-transform">
                                <CardContent className="p-4">
                                    <div className="flex justify-between items-start mb-3">
                                        <div>
                                            <span className="font-mono text-xs text-slate-400">#{order.id.slice(0, 8)}</span>
                                            <p className="text-xs text-slate-500">{new Date(order.date).toLocaleString()}</p>
                                        </div>
                                        <Badge variant={order.status === 'completed' ? 'success' : 'danger'}>
                                            {order.status.toUpperCase()}
                                        </Badge>
                                    </div>
                                    <div className="space-y-1 mb-3 bg-slate-50 p-2 rounded border border-slate-100">
                                        {order.items.map((item, i) => (
                                            <div key={i} className="flex justify-between text-sm">
                                                <span className="text-slate-600"><span className="font-bold text-slate-800">{item.qty}x</span> {item.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center border-t border-slate-50 pt-3">
                                        <span className="text-sm font-medium text-slate-500">Total</span>
                                        <span className="text-lg font-bold text-slate-800">${order.total.toFixed(2)}</span>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            );
        };

        // --- RESTOCK VIEW ---
        const Restock = () => {
            const { inventory, restockIngredient } = useData();
            const [selectedId, setSelectedId] = useState("");
            const [qty, setQty] = useState("");
            const [unitCost, setUnitCost] = useState("");

            const handleRestock = (e) => {
                e.preventDefault();
                if (!selectedId || !qty || !unitCost) return;
                const totalCost = parseFloat(qty) * parseFloat(unitCost);
                restockIngredient(parseInt(selectedId), parseFloat(qty), totalCost);
                setQty("");
                setUnitCost("");
                addNotification("Restock Successful", `Added ${qty} units. Cost: $${totalCost.toFixed(2)}`, "success");
            };

            const selectedItem = inventory.find(i => i.id === parseInt(selectedId));

            return (
                <div className="max-w-2xl mx-auto fade-in">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Restock Inventory</h2>
                    <Card>
                        <CardHeader><CardTitle>Log Purchase & Update Stock</CardTitle></CardHeader>
                        <CardContent>
                            <form onSubmit={handleRestock} className="space-y-6">
                                <div>
                                    <Label>Select Ingredient</Label>
                                    <Select value={selectedId} onChange={e => setSelectedId(e.target.value)} required>
                                        <option value="">-- Select Item --</option>
                                        {inventory.map(item => (
                                            <option key={item.id} value={item.id}>
                                                {item.name} (Current: {item.stock} {item.unit})
                                            </option>
                                        ))}
                                    </Select>
                                </div>

                                {selectedItem && (
                                    <div className="bg-blue-50 p-4 rounded-lg flex gap-4 items-center text-blue-700 text-sm">
                                        <Icon name="info" size={16} />
                                        <span>Current Stock: <strong>{selectedItem.stock} {selectedItem.unit}</strong></span>
                                        <span>|</span>
                                        <span>Est. Cost: <strong>${selectedItem.cost}/{selectedItem.unit}</strong></span>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <Label>Quantity Added ({selectedItem ? selectedItem.unit : 'Unit'})</Label>
                                        <Input
                                            type="number"
                                            step="0.01"
                                            value={qty}
                                            onChange={e => setQty(e.target.value)}
                                            placeholder="0.00"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <Label>Unit Cost ($)</Label>
                                        <Input
                                            type="number"
                                            step="0.01"
                                            value={unitCost}
                                            onChange={e => setUnitCost(e.target.value)}
                                            placeholder="0.00"
                                            required
                                        />
                                    </div>
                                </div>

                                <Button type="submit" size="lg" className="w-full" disabled={!selectedId}>
                                    <Icon name="plus-circle" size={20} /> Confirm Restock
                                </Button>
                            </form>
                        </CardContent>
                    </Card>
                </div>
            );
        };

        // --- PURCHASE ORDERS VIEW (Modernized) ---
        const PurchaseOrders = () => {
            const { purchaseOrders, inventory, addPO, deletePO, receivePO } = useData();
            const [isAdding, setIsAdding] = useState(false);
            const [formData, setFormData] = useState({ vendor: '', deliveryDate: '', items: [] });
            const [newItem, setNewItem] = useState({ id: '', qty: '', unitCost: '' });

            const handleSave = (e) => {
                e.preventDefault();
                if (formData.items.length === 0) {
                    alert("Please add at least one item.");
                    return;
                }
                addPO(formData);
                setIsAdding(false);
                setFormData({ vendor: '', deliveryDate: '', items: [] });
            };

            const addItem = () => {
                if (!newItem.id || !newItem.qty || !newItem.unitCost) return;
                setFormData({
                    ...formData,
                    items: [...formData.items, { id: parseInt(newItem.id), qty: parseFloat(newItem.qty), unitCost: parseFloat(newItem.unitCost) }]
                });
                setNewItem({ id: '', qty: '', unitCost: '' });
            };

            const removeItem = (idx) => {
                setFormData({ ...formData, items: formData.items.filter((_, i) => i !== idx) });
            };

            const sortedPOs = [...purchaseOrders].sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            return (
                <div className="space-y-6 fade-in pb-20">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">Purchase Orders</h2>
                        <Button onClick={() => setIsAdding(true)}><Icon name="plus" size={18} /> New Order</Button>
                    </div>

                    <div className="grid grid-cols-1 gap-6">
                        {sortedPOs.length === 0 && (
                            <div className="text-center py-12 bg-slate-50 rounded-lg border border-slate-100 border-dashed">
                                <p className="text-slate-400">No purchase orders found.</p>
                            </div>
                        )}
                        {sortedPOs.map(po => (
                            <Card key={po.id} className="relative overflow-hidden hover:shadow-md transition-all">
                                <div className={`absolute left-0 top-0 bottom-0 w-1 ${po.status === 'received' ? 'bg-emerald-500' : po.status === 'cancelled' ? 'bg-red-500' : 'bg-orange-500'}`}></div>
                                <CardContent className="pl-6 pt-6">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                                        <div>
                                            <div className="flex items-center gap-3 mb-1">
                                                <h3 className="font-bold text-lg text-slate-800">{po.vendor}</h3>
                                                <Badge variant={po.status === 'received' ? 'success' : po.status === 'cancelled' ? 'danger' : 'warning'}>
                                                    {po.status.toUpperCase()}
                                                </Badge>
                                            </div>
                                            <div className="flex gap-4 text-sm text-slate-500">
                                                <span>Order #{po.id.slice(0, 8)}</span>
                                                <span>‚Ä¢</span>
                                                <span>Delivery: <span className="font-medium text-slate-700">{new Date(po.deliveryDate).toLocaleDateString()}</span></span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            {po.status === 'pending' && (
                                                <>
                                                    <Button variant="secondary" size="sm" onClick={() => { if (confirm("Mark as Received? Stock will be updated.")) receivePO(po.id); }} className="flex-1 md:flex-none">
                                                        <Icon name="check-circle" size={16} /> Receive
                                                    </Button>
                                                    <Button variant="danger" size="sm" onClick={() => { if (confirm("Cancel this PO?")) deletePO(po.id); }} className="flex-1 md:flex-none">
                                                        <Icon name="x-circle" size={16} /> Cancel
                                                    </Button>
                                                </>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 rounded-lg p-3 text-sm border border-slate-100">
                                        <div className="grid grid-cols-12 font-medium text-slate-500 mb-2 px-2 text-xs uppercase tracking-wider">
                                            <div className="col-span-6">Item</div>
                                            <div className="col-span-2 text-center">Qty</div>
                                            <div className="col-span-2 text-center">Cost</div>
                                            <div className="col-span-2 text-right">Total</div>
                                        </div>
                                        <div className="space-y-1">
                                            {po.items.map((item, idx) => {
                                                const invItem = inventory.find(i => i.id === item.id);
                                                return (
                                                    <div key={idx} className="grid grid-cols-12 items-center px-2 py-1.5 border-b border-slate-200/50 last:border-0 hover:bg-slate-100 transition-colors rounded">
                                                        <div className="col-span-6 font-medium text-slate-700">{invItem ? invItem.name : 'Unknown'}</div>
                                                        <div className="col-span-2 text-center text-slate-600">{item.qty} {invItem?.unit}</div>
                                                        <div className="col-span-2 text-center text-slate-600">${item.unitCost.toFixed(2)}</div>
                                                        <div className="col-span-2 text-right font-medium text-slate-800">${(item.qty * item.unitCost).toFixed(2)}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="mt-3 pt-3 border-t border-slate-200 flex justify-end items-center gap-2">
                                            <span className="text-slate-500 text-xs uppercase">Total Amount</span>
                                            <span className="font-bold text-lg text-slate-800">${po.items.reduce((sum, i) => sum + (i.qty * i.unitCost), 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-900/40 flex items-center justify-center p-4 z-50 backdrop-blur-sm animate-in fade-in">
                            <Card className="w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl">
                                <CardHeader className="flex flex-row items-center justify-between border-b border-slate-100 pb-4">
                                    <CardTitle>Create Purchase Order</CardTitle>
                                    <button onClick={() => setIsAdding(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" size={20} /></button>
                                </CardHeader>
                                <CardContent className="overflow-y-auto pt-4">
                                    <form onSubmit={handleSave} className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Vendor Name</label>
                                                <Input value={formData.vendor} onChange={e => setFormData({ ...formData, vendor: e.target.value })} required placeholder="e.g. Sysco" />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-sm font-medium text-slate-700">Delivery Date</label>
                                                <Input type="date" value={formData.deliveryDate} onChange={e => setFormData({ ...formData, deliveryDate: e.target.value })} required />
                                            </div>
                                        </div>

                                        <div className="border rounded-xl border-slate-200 p-4 bg-slate-50/50">
                                            <label className="text-sm font-bold text-slate-700 mb-3 block">Order Items</label>

                                            {/* Add Item Row */}
                                            <div className="flex flex-col md:flex-row gap-2 mb-4 items-end bg-white p-3 rounded-lg border border-slate-200">
                                                <div className="flex-1 w-full">
                                                    <span className="text-xs text-slate-500 mb-1 block font-medium">Ingredient</span>
                                                    <select className="w-full h-10 rounded-md border border-slate-200 bg-white px-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20" value={newItem.id} onChange={e => setNewItem({ ...newItem, id: e.target.value })}>
                                                        <option value="">Select Item...</option>
                                                        {inventory.map(i => <option key={i.id} value={i.id}>{i.name} ({i.unit})</option>)}
                                                    </select>
                                                </div>
                                                <div className="w-full md:w-24">
                                                    <span className="text-xs text-slate-500 mb-1 block font-medium">Qty</span>
                                                    <Input type="number" step="0.01" value={newItem.qty} onChange={e => setNewItem({ ...newItem, qty: e.target.value })} placeholder="0" />
                                                </div>
                                                <div className="w-full md:w-28">
                                                    <span className="text-xs text-slate-500 mb-1 block font-medium">Unit Cost ($)</span>
                                                    <Input type="number" step="0.01" value={newItem.unitCost} onChange={e => setNewItem({ ...newItem, unitCost: e.target.value })} placeholder="0.00" />
                                                </div>
                                                <div className="md:mb-px">
                                                    <Button type="button" onClick={addItem} size="md" className="w-full md:w-auto"><Icon name="plus" size={16} /> Add</Button>
                                                </div>
                                            </div>

                                            {/* Items List */}
                                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                                {formData.items.length === 0 && (
                                                    <div className="text-center py-6 text-slate-400 text-sm border-2 border-dashed border-slate-200 rounded-lg">
                                                        No items added to this order yet.
                                                    </div>
                                                )}
                                                {formData.items.map((item, idx) => {
                                                    const invItem = inventory.find(i => i.id === item.id);
                                                    return (
                                                        <div key={idx} className="flex flex-wrap md:flex-nowrap justify-between items-center bg-white p-3 rounded-lg border border-slate-100 shadow-sm text-sm group">
                                                            <div className="flex items-center gap-3 w-full md:w-auto">
                                                                <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold">{idx + 1}</div>
                                                                <span className="font-medium text-slate-700">{invItem ? invItem.name : 'Unknown Item'}</span>
                                                            </div>
                                                            <div className="flex items-center gap-4 mt-2 md:mt-0 ml-9 md:ml-0 w-full md:w-auto justify-between md:justify-end">
                                                                <div className="text-right">
                                                                    <span className="block text-xs text-slate-400">Qty</span>
                                                                    <span className="font-medium text-slate-700">{item.qty} {invItem?.unit}</span>
                                                                </div>
                                                                <div className="text-right">
                                                                    <span className="block text-xs text-slate-400">Cost</span>
                                                                    <span className="font-medium text-slate-700">${item.unitCost}</span>
                                                                </div>
                                                                <div className="text-right w-20">
                                                                    <span className="block text-xs text-slate-400">Total</span>
                                                                    <span className="font-bold text-slate-800">${(item.qty * item.unitCost).toFixed(2)}</span>
                                                                </div>
                                                                <button type="button" onClick={() => removeItem(idx)} className="text-slate-300 hover:text-red-500 p-2"><Icon name="x" size={18} /></button>
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                            </div>

                                            {formData.items.length > 0 && (
                                                <div className="mt-4 pt-3 border-t border-slate-200 flex justify-end items-center gap-3">
                                                    <span className="text-slate-500 font-medium">Order Total:</span>
                                                    <span className="text-xl font-bold text-slate-800">${formData.items.reduce((sum, i) => sum + (i.qty * i.unitCost), 0).toFixed(2)}</span>
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex gap-3 justify-end pt-4 border-t border-slate-100">
                                            <Button type="button" variant="secondary" onClick={() => setIsAdding(false)} className="bg-slate-100 text-slate-600 hover:bg-slate-200">Cancel</Button>
                                            <Button type="submit" disabled={formData.items.length === 0}>Create Purchase Order</Button>
                                        </div>
                                    </form>
                                </CardContent>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        // --- SETTINGS VIEW (Modernized) ---
        const Settings = () => {
            const { resetData } = useData();
            const [username, setUsername] = useState(localStorage.getItem('rb_user') || 'Guest');
            const scriptUrl = localStorage.getItem('rb_script_url');

            const handleLogout = () => {
                if (confirm("Log out?")) {
                    localStorage.removeItem('rb_user');
                    window.location.reload();
                }
            };

            const handleBackup = () => {
                const data = JSON.stringify(localStorage);
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `restrobuddy_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            return (
                <div className="max-w-4xl mx-auto space-y-8 fade-in pb-20">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800">Settings</h2>
                        <p className="text-slate-500 text-sm">Manage your account and application preferences.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Profile Card */}
                        <Card className="md:col-span-1">
                            <CardHeader><CardTitle>Profile</CardTitle></CardHeader>
                            <CardContent>
                                <div className="flex flex-col items-center text-center py-4">
                                    <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center text-3xl mb-3">
                                        üë§
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800">{username.charAt(0).toUpperCase() + username.slice(1)}</h3>
                                    <p className="text-xs text-slate-500 mb-4">Store Manager</p>
                                    <Button variant="secondary" onClick={handleLogout} className="w-full border border-slate-200">
                                        <Icon name="log-out" size={16} /> Logout
                                    </Button>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Main Settings Column */}
                        <div className="md:col-span-2 space-y-6">
                            {/* Cloud Integration */}
                            <Card>
                                <CardHeader><CardTitle>Cloud Synchronization</CardTitle></CardHeader>
                                <CardContent>
                                    <div className="flex items-start gap-4">
                                        <div className={`p-3 rounded-xl ${scriptUrl ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>
                                            <Icon name="cloud" size={24} />
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="font-semibold text-slate-800">Google Sheets Backend</h4>
                                            <p className="text-sm text-slate-500 mb-2">
                                                {scriptUrl
                                                    ? 'Connected and syncing data in real-time.'
                                                    : 'Not connected. running in offline mode.'}
                                            </p>
                                            {scriptUrl && (
                                                <div className="text-xs font-mono bg-slate-50 p-2 rounded border border-slate-100 truncate text-slate-400">
                                                    {scriptUrl}
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex items-center">
                                            <span className={`flex h-3 w-3 rounded-full ${scriptUrl ? 'bg-emerald-500' : 'bg-slate-300'}`}></span>
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>

                            {/* Data Management */}
                            <Card>
                                <CardHeader><CardTitle>Data Management</CardTitle></CardHeader>
                                <CardContent className="space-y-4">
                                    <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                                        <div>
                                            <h4 className="font-medium text-slate-700">Export Backup</h4>
                                            <p className="text-xs text-slate-500">Download a JSON file of your local data.</p>
                                        </div>
                                        <Button variant="secondary" onClick={handleBackup}><Icon name="download" size={16} /> Export</Button>
                                    </div>

                                    <div className="border-t border-slate-100 pt-4">
                                        <h4 className="font-medium text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" size={16} /> Danger Zone</h4>
                                        <p className="text-xs text-slate-500 mb-3">Irreversible actions. Please proceed with caution.</p>
                                        <Button variant="danger" onClick={() => { if (confirm("Are you sure? This deletes ALL local data.")) resetData(); }} className="w-full sm:w-auto">
                                            <Icon name="trash-2" size={16} /> Factory Reset App
                                        </Button>
                                    </div>
                                </CardContent>
                            </Card>

                            {/* App Info */}
                            <div className="text-center pt-4">
                                <p className="text-xs text-slate-400">RestroBuddy v1.2.0 ‚Ä¢ Build 2026.02.12</p>
                                <p className="text-xs text-slate-300 mt-1">Made with ‚ù§Ô∏è for Local Businesses</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- AUTH COMPONENT ---
        const Auth = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [formData, setFormData] = useState({ username: '', password: '' });
            const [error, setError] = useState('');

            // Safe LocalStorage Parser
            const getLocalUsers = () => {
                try {
                    return JSON.parse(localStorage.getItem('rb_users') || '{}');
                } catch (e) {
                    console.error("Data corruption detected", e);
                    return {};
                }
            };

            const handleReset = () => {
                if (confirm("This will clear all local data. Continue?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                const username = formData.username.trim().toLowerCase();
                const password = formData.password.trim();

                if (!username || !password) { setError("All fields are required"); return; }

                // Cloud Auth
                if (SCRIPT_URL) {
                    try {
                        const action = isRegister ? 'REGISTER' : 'LOGIN';
                        const res = await GoogleSheetsService.call(action, { password }, username);

                        if (res && res.status === 'success') {
                            if (isRegister) {
                                alert("Account created on Cloud! Please login.");
                                setIsRegister(false);
                                setFormData({ username: '', password: '' });
                            } else {
                                onLogin(username);
                            }
                        } else {
                            setError(res?.message || "Cloud Authentication failed");
                        }
                    } catch (err) {
                        setError("Connection error: " + err.message);
                    }
                    return;
                }

                // Local Auth Fallback
                const users = getLocalUsers();

                if (isRegister) {
                    if (users[username]) { setError("Username already taken"); return; }
                    users[username] = { password };
                    localStorage.setItem('rb_users', JSON.stringify(users));
                    alert("Account created! Please login.");
                    setIsRegister(false);
                    setFormData({ username: '', password: '' });
                } else {
                    if (!users[username] || users[username].password !== password) {
                        setError("Invalid credentials");
                        return;
                    }
                    onLogin(username);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4 relative overflow-hidden">
                    <div className="absolute inset-0 z-0">
                        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-orange-200 rounded-full blur-[100px] opacity-30"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-200 rounded-full blur-[100px] opacity-30"></div>
                    </div>

                    <Card className="w-full max-w-md relative z-10 border-0 shadow-2xl bg-white/80 backdrop-blur-xl">
                        <CardHeader className="text-center pb-2">
                            <div className="w-16 h-16 bg-gradient-to-br from-orange-400 to-red-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-orange-200 mb-4 transform rotate-[-5deg]">
                                <Icon name="pizza" size={32} className="text-white" />
                            </div>
                            <CardTitle className="text-2xl font-bold text-slate-800">RestroBuddy</CardTitle>
                            <p className="text-slate-500 text-sm mt-1">Restaurant Management System</p>
                        </CardHeader>
                        <CardContent>
                            {error && (
                                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 flex items-center gap-2 border border-red-100">
                                    <Icon name="alert-circle" size={16} />
                                    {error}
                                </div>
                            )}

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1.5 ml-1">Username</label>
                                    <Input
                                        placeholder="Enter your username"
                                        value={formData.username}
                                        onChange={e => setFormData({ ...formData, username: e.target.value })}
                                        className="h-11 bg-slate-50 border-slate-200 focus:bg-white transition-all"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1.5 ml-1">Password</label>
                                    <Input
                                        type="password"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        value={formData.password}
                                        onChange={e => setFormData({ ...formData, password: e.target.value })}
                                        className="h-11 bg-slate-50 border-slate-200 focus:bg-white transition-all"
                                    />
                                </div>
                                <Button type="submit" className="w-full h-11 text-base font-medium shadow-orange-200 shadow-lg mt-2">
                                    {isRegister ? 'Create Account' : 'Sign In'}
                                </Button>
                            </form>

                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => { setIsRegister(!isRegister); setError(''); }}
                                    className="text-sm text-slate-500 hover:text-orange-600 font-medium transition-colors"
                                >
                                    {isRegister ? 'Already have an account? Sign In' : 'Need an account? Create one'}
                                </button>
                            </div>

                            <div className="mt-8 pt-4 border-t border-slate-100 flex justify-center">
                                <button onClick={handleReset} className="text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors">
                                    <Icon name="trash-2" size={12} /> Factory Reset
                                </button>
                            </div>
                        </CardContent>
                    </Card>

                    <div className="absolute bottom-4 text-center w-full text-slate-400 text-xs">
                        &copy; {new Date().getFullYear()} RestroBuddy. Local-first & Cloud-synced.
                    </div>
                </div>
            );
        };

        // --- MAIN APP SHELL ---
        const AppContent = ({ onLogout }) => {
            const { purchaseOrders, receivePO, deletePO, updatePODate } = useData();
            const [view, setView] = useState('dashboard');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [duePO, setDuePO] = useState(null);

            // PO Check Effect
            useEffect(() => {
                const checkDuePOs = () => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const foundPO = purchaseOrders.find(po => {
                        if (po.status !== 'pending') return false;
                        // Convert delivery date string to date object and remove time
                        const delivery = new Date(po.deliveryDate);
                        // We need to account for timezone potential issues, usually date input is YYYY-MM-DD
                        // new Date("YYYY-MM-DD") is UTC, but new Date() is local.
                        // Let's create date from parts to be safe as local time 00:00:00
                        const parts = po.deliveryDate.split('-');
                        const deliveryLocal = new Date(parts[0], parts[1] - 1, parts[2]);

                        return deliveryLocal <= today;
                    });

                    if (foundPO) setDuePO(foundPO);
                };

                const timer = setTimeout(checkDuePOs, 1000);
                return () => clearTimeout(timer);
            }, [purchaseOrders]);

            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'pos', label: 'POS', icon: 'shopping-cart' },
                { id: 'orders', label: 'Orders', icon: 'chef-hat' },
                { id: 'inventory', label: 'Inventory', icon: 'package' },
                { id: 'menu', label: 'Menu', icon: 'book-open' }, // Shortened labels for mobile
            ];

            // Mobile Bottom Nav specific items (limit to 4-5)
            const mobileNavItems = [
                { id: 'dashboard', label: 'Dash', icon: 'layout-dashboard' },
                { id: 'pos', label: 'POS', icon: 'shopping-cart' },
                { id: 'orders', label: 'Orders', icon: 'chef-hat' },
                { id: 'inventory', label: 'Inv', icon: 'package' },
            ];

            return (
                <div className="flex h-screen bg-background overflow-hidden relative">
                    {/* Desktop Sidebar (Hidden on Mobile) */}
                    <aside className="hidden lg:flex w-64 bg-white border-r border-slate-100 flex-col shadow-lg z-20">
                        <div className="p-6 border-b border-slate-50 flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-orange-400 to-red-600 text-white rounded-xl flex items-center justify-center shadow-orange-200 shadow-lg">
                                <Icon name="pizza" size={20} />
                            </div>
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 tracking-tight">
                                RestroBuddy
                            </h1>
                        </div>

                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            {navItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setView(item.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${view === item.id
                                        ? 'bg-orange-50 text-orange-600 font-semibold shadow-sm'
                                        : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                                        }`}
                                >
                                    <Icon name={item.icon} size={20} className={view === item.id ? "text-orange-500" : "text-slate-400 group-hover:text-slate-600"} />
                                    <span>{item.label}</span>
                                    {view === item.id && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-orange-500"></div>}
                                </button>
                            ))}
                            {/* Secondary Nav Items */}
                            <div className="pt-4 mt-4 border-t border-slate-100">
                                <button onClick={() => setView('restock')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors text-slate-500 hover:bg-slate-50 ${view === 'restock' ? 'bg-orange-50 text-orange-600' : ''}`}>
                                    <Icon name="refresh-cw" size={20} /> <span>Restock</span>
                                </button>
                                <button onClick={() => setView('purchase-orders')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors text-slate-500 hover:bg-slate-50 ${view === 'purchase-orders' ? 'bg-orange-50 text-orange-600' : ''}`}>
                                    <Icon name="truck" size={20} /> <span>Purchases</span>
                                </button>
                                <button onClick={() => setView('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors text-slate-500 hover:bg-slate-50 ${view === 'settings' ? 'bg-orange-50 text-orange-600' : ''}`}>
                                    <Icon name="settings" size={20} /> <span>Settings</span>
                                </button>
                            </div>
                        </nav>

                        <div className="p-4 m-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center font-bold text-orange-600 uppercase border border-slate-100">
                                {localStorage.getItem('rb_user')?.charAt(0) || 'U'}
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-semibold truncate capitalize text-slate-800">{localStorage.getItem('rb_user') || 'User'}</p>
                                <p className="text-xs text-slate-400">Manager</p>
                            </div>
                            <button onClick={onLogout} className="text-slate-400 hover:text-red-500 transition-colors p-1" title="Logout">
                                <Icon name="log-out" size={18} />
                            </button>
                        </div>
                    </aside>

                    {/* Mobile Bottom Navigation (Visible on Mobile) */}
                    <nav className="lg:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-slate-200 flex items-center justify-around z-50 glass safe-area-bottom pb-1">
                        {mobileNavItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setView(item.id)}
                                className={`flex flex-col items-center justify-center w-full h-full pt-1 ${view === item.id ? 'text-orange-600' : 'text-slate-400'}`}
                            >
                                <div className={`p-1.5 rounded-full mb-0.5 transition-all ${view === item.id ? 'bg-orange-100 translate-y-[-2px]' : ''}`}>
                                    <Icon name={item.icon} size={20} />
                                </div>
                                <span style={{ fontSize: '10px' }} className="font-medium">{item.label}</span>
                            </button>
                        ))}
                        <button
                            onClick={() => setView('settings')} // Use menu for "More"?
                            className={`flex flex-col items-center justify-center w-full h-full pt-1 ${view === 'settings' ? 'text-orange-600' : 'text-slate-400'}`}
                        >
                            <div className={`p-1.5 rounded-full mb-0.5 transition-all ${view === 'settings' ? 'bg-orange-100' : ''}`}>
                                <Icon name="menu" size={20} />
                            </div>
                            <span style={{ fontSize: '10px' }} className="font-medium">More</span>
                        </button>
                    </nav>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50/50">
                        {/* Header (Desktop: Sticky, Mobile: Simple Top Bar) */}
                        <header className="glass sticky top-0 z-30 px-6 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                {/* Mobile Logo Only */}
                                <div className="lg:hidden w-8 h-8 bg-gradient-to-br from-orange-400 to-red-600 text-white rounded-lg flex items-center justify-center shadow-md">
                                    <Icon name="pizza" size={16} />
                                </div>
                                <h1 className="font-bold text-lg text-slate-800 capitalize tracking-tight">{view.replace('-', ' ')}</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <NotificationBell />
                            </div>
                        </header>

                        {/* View Area (Padding bottom for mobile nav) */}
                        <div className="flex-1 overflow-auto p-4 md:p-8 pb-24 lg:pb-8 relative scroll-smooth">
                            {view === 'dashboard' && <Dashboard />}
                            {view === 'pos' && <POS />}
                            {view === 'orders' && (
                                <div className="space-y-6 fade-in">
                                    <div className="flex items-center gap-2 p-1 bg-slate-200/50 rounded-xl w-fit">
                                        <button className="px-4 py-2 rounded-lg bg-white shadow-sm text-sm font-medium text-slate-800">Active Kitchen</button>
                                        <button className="px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800" onClick={() => setView('history')}>History</button>
                                    </div>
                                    <Kitchen />
                                </div>
                            )}
                            {view === 'history' && (
                                <div className="space-y-6 fade-in">
                                    <div className="flex items-center gap-2 p-1 bg-slate-200/50 rounded-xl w-fit">
                                        <button className="px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800" onClick={() => setView('orders')}>Active Kitchen</button>
                                        <button className="px-4 py-2 rounded-lg bg-white shadow-sm text-sm font-medium text-slate-800">History</button>
                                    </div>
                                    <OrdersHistory />
                                </div>
                            )}
                            {view === 'inventory' && <Inventory />}
                            {view === 'menu' && <Menu />}
                            {view === 'restock' && <Restock />}
                            {view === 'purchase-orders' && <PurchaseOrders />}
                            {view === 'settings' && <Settings />}
                        </div>
                    </main>

                    {/* Due PO Modal */}
                    {duePO && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60] backdrop-blur-sm">
                            <Card className="w-full max-w-md animate-in fade-in zoom-in-95 shadow-2xl border-orange-200">
                                <CardHeader className="bg-orange-50 border-b border-orange-100">
                                    <CardTitle className="text-orange-800 flex items-center gap-2">
                                        <Icon name="truck" size={20} /> Delivery Confirmation
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="pt-6">
                                    <p className="mb-4 text-slate-700">Did the purchase order from <strong>{duePO.vendor}</strong> (Due: {new Date(duePO.deliveryDate).toLocaleDateString()}) arrive?</p>

                                    <div className="flex flex-col gap-3">
                                        <Button variant="success" onClick={() => { receivePO(duePO.id); setDuePO(null); }}>Yes, Order Arrived</Button>
                                        <div className="text-center text-xs text-slate-400 font-medium my-1">- OR -</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <Button variant="outline" onClick={() => {
                                                const newDate = prompt("Enter new delivery date (YYYY-MM-DD):", duePO.deliveryDate);
                                                if (newDate) {
                                                    updatePODate(duePO.id, newDate);
                                                    setDuePO(null);
                                                }
                                            }}>Update Date</Button>
                                            <Button variant="danger" onClick={() => {
                                                if (confirm("Delete this purchase order permanently?")) {
                                                    deletePO(duePO.id);
                                                    setDuePO(null);
                                                }
                                            }}>Delete</Button>
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(() => localStorage.getItem('rb_user') || null);

            const handleLogin = (username) => {
                localStorage.setItem('rb_user', username);
                setUser(username);
            };

            const handleLogout = () => {
                localStorage.removeItem('rb_user');
                setUser(null);
                window.location.reload();
            };

            return (
                <ErrorBoundary>
                    <DataProvider user={user}>
                        {user ? <AppContent onLogout={handleLogout} /> : <Auth onLogin={handleLogin} />}
                    </DataProvider>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
